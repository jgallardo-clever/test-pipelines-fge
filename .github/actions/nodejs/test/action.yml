name: Action para ejecutar pruebas de Node.js
description: Acción para ejecutar pruebas de una aplicación Node.js
runs:
  using: "composite"
  steps:
    - name: Buscamos el directorio de la aplicación
      id: find_project_directory
      shell: powershell
      working-directory: ./app
      run: |
        echo "Buscando el directorio del proyecto..."

        # Buscamos el archivo package-lock.json para determinar el directorio del proyecto
        $projectDir = Get-ChildItem -Recurse -Filter package-lock.json | Select-Object -First 1 | ForEach-Object { $_.DirectoryName }
        if (-not $projectDir) {
          Write-Error "No se encontró el archivo package-lock.json"
          exit 1
        }

        # Exportamos la variable de entorno con el directorio de la aplicación
        echo "project_directory=$projectDir" >> $env:GITHUB_OUTPUT
        
        echo "Directorio de la aplicación: $projectDir"

    # Step para validar si existe el comando/script para ejecutar pruebas en el package.json
    - name: Validar existencia de script de pruebas
      id: test_script
      shell: powershell
      working-directory: ${{ steps.find_project_directory.outputs.project_directory }}
      run: |
        $packageJson = Get-Content package.json | ConvertFrom-Json
        if (-not $packageJson.scripts.test) {
          echo "No se encontró el script de pruebas en package.json"
          echo "has_tests=false" >> $env:GITHUB_OUTPUT
          exit 0
        }
        echo "Script de pruebas encontrado: $($packageJson.scripts.test)"
        echo "has_tests=true" >> $env:GITHUB_OUTPUT
        if ($packageJson.scripts.tests -eq "jest") {
          echo "Usando Jest para pruebas"
          echo 'test_command="npm test"' >> $env:GITHUB_OUTPUT
        } elseif ($packageJson.scripts.test -eq "ng test") {
          echo "Usando Angular para pruebas"
          echo 'test_command="ng test -- --watch=false --browsers=ChromeHeadless"' >> $env:GITHUB_OUTPUT
        } else {
          echo "Usando script por defecto"
          echo 'test_command="npm test"' >> $env:GITHUB_OUTPUT
        }

    - name: Ejecutamos las pruebas
      shell: powershell
      if: ${{ steps.test_script.outputs.has_tests == 'true' }}
      working-directory: ${{ steps.find_project_directory.outputs.project_directory }}
      run: |
        echo "Ejecutando las pruebas..."
        $testCommand = ${{ steps.test_script.outputs.test_command }}
        Invoke-Expression $testCommand
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Las pruebas fallaron"
          exit 1
        }
        else {
          Write-Host "Las pruebas se ejecutaron correctamente"
        }
